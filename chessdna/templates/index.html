<!doctype html>
<html lang="zh-Hant">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ChessDNA</title>

  <!-- PWA -->
  <link rel="manifest" href="/static/manifest.json" />
  <meta name="theme-color" content="#0b0f19" />
  <!-- iOS PWA -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="ChessDNA" />
  <link rel="apple-touch-icon" href="/static/icons/icon-192.png" />

  <style>
    :root {
      --bg: #0b0f19;
      --card: #111827;
      --card2: #0f172a;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --line: rgba(255, 255, 255, .08);
      --accent: #60a5fa;
      --accent2: #22c55e;
      --bad: #fb7185;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: system-ui, Segoe UI, Roboto, Helvetica, Arial;
      margin: 0;
      padding-bottom: 90px;
      background: radial-gradient(1000px 600px at 20% 0%, rgba(96, 165, 250, .18), transparent 60%),
        radial-gradient(800px 500px at 90% 10%, rgba(34, 197, 94, .12), transparent 60%),
        var(--bg);
      color: var(--text);
    }

    .wrap {
      max-width: 980px;
      margin: 20px auto;
      padding: 0 16px;
    }

    .header {
      display: flex;
      align-items: flex-end;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 12px;
    }

    .brand h1 {
      margin: 0;
      font-size: 28px;
      letter-spacing: .2px;
    }

    .brand p {
      margin: 4px 0 0;
      color: var(--muted);
      font-size: 13px;
    }

    .pill {
      border: 1px solid var(--line);
      padding: 6px 10px;
      border-radius: 999px;
      color: var(--muted);
      font-size: 12px;
      background: rgba(255, 255, 255, .03)
    }

    .card {
      background: linear-gradient(180deg, rgba(255, 255, 255, .04), rgba(255, 255, 255, .02));
      border: 1px solid var(--line);
      border-radius: 16px;
      overflow: hidden;
    }

    .cardHead {
      padding: 12px 16px;
      border-bottom: 1px solid var(--line);
      background: rgba(17, 24, 39, .55)
    }

    .cardHead strong {
      font-size: 14px;
    }

    .cardBody {
      padding: 16px;
    }

    input,
    button,
    textarea,
    select {
      font-size: 14px;
    }

    input,
    textarea,
    select {
      width: 100%;
      background: rgba(15, 23, 42, .65);
      color: var(--text);
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 9px 12px;
      outline: none;
      transition: border-color .2s, box-shadow .2s;
    }

    input:focus,
    textarea:focus,
    select:focus {
      border-color: rgba(96, 165, 250, .55);
      box-shadow: 0 0 0 3px rgba(96, 165, 250, .15)
    }

    textarea {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;
    }

    label {
      display: block;
      margin: 0 0 6px;
      font-weight: 650;
      font-size: 13px;
      color: #f3f4f6;
    }

    .hint {
      color: var(--muted);
      font-size: 11px;
      margin-top: 4px;
      line-height: 1.4
    }

    /* â”€â”€ Tabs â”€â”€ */
    .tabs {
      display: flex;
      gap: 0;
      border-bottom: 2px solid var(--line);
      margin-bottom: 14px;
    }

    .tab {
      padding: 10px 18px;
      font-size: 13px;
      font-weight: 700;
      background: transparent;
      border: none;
      color: var(--muted);
      cursor: pointer;
      border-bottom: 2px solid transparent;
      margin-bottom: -2px;
      transition: color .2s, border-color .2s;
      white-space: nowrap;
    }

    .tab:hover {
      color: var(--text);
    }

    .tab.active {
      color: var(--accent);
      border-bottom-color: var(--accent);
    }

    .tabPanel {
      display: none;
    }

    .tabPanel.active {
      display: block;
    }

    /* â”€â”€ Settings toggle â”€â”€ */
    .settingsToggle {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      cursor: pointer;
      border: 1px solid var(--line);
      border-radius: 12px;
      background: rgba(15, 23, 42, .35);
      transition: background .2s;
      margin-bottom: 12px;
    }

    .settingsToggle:hover {
      background: rgba(15, 23, 42, .55);
    }

    .settingsToggle .arrow {
      font-size: 11px;
      transition: transform .2s;
    }

    .settingsToggle .arrow.open {
      transform: rotate(90deg);
    }

    .settingsSummary {
      color: var(--muted);
      font-size: 12px;
      margin-left: auto;
    }

    .settingsBody {
      display: none;
      padding: 0 2px;
    }

    .settingsBody.open {
      display: block;
    }

    /* â”€â”€ Buttons â”€â”€ */
    .btnRow {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 12px;
      align-items: center;
    }

    .btn {
      padding: 9px 16px;
      border: 1px solid rgba(255, 255, 255, .10);
      border-radius: 10px;
      background: rgba(96, 165, 250, .14);
      color: var(--text);
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      transition: background .2s, transform .1s, box-shadow .2s;
    }

    .btn:hover {
      background: rgba(96, 165, 250, .22);
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(96, 165, 250, .15);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn:disabled {
      opacity: .5;
      cursor: not-allowed;
      transform: none !important;
      box-shadow: none !important;
    }

    .btnOutline {
      background: transparent;
      border: 1.5px solid rgba(96, 165, 250, .45);
      color: var(--accent);
    }

    .btnOutline:hover {
      background: rgba(96, 165, 250, .10);
    }

    /* â”€â”€ Sticky Action Bar â”€â”€ */
    .actionBar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 100;
      background: rgba(11, 15, 25, .92);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-top: 1px solid var(--line);
      padding: 12px 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 14px;
    }

    .btnAnalyze {
      padding: 12px 32px;
      border: none;
      border-radius: 12px;
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      color: #fff;
      cursor: pointer;
      font-size: 15px;
      font-weight: 700;
      letter-spacing: .3px;
      transition: transform .15s, box-shadow .2s, opacity .2s;
      box-shadow: 0 4px 16px rgba(37, 99, 235, .35);
    }

    .btnAnalyze:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 24px rgba(37, 99, 235, .45);
    }

    .btnAnalyze:active {
      transform: translateY(0);
    }

    .btnAnalyze:disabled {
      opacity: .5;
      cursor: not-allowed;
      transform: none !important;
      box-shadow: none !important;
    }

    .actionInfo {
      color: var(--muted);
      font-size: 12px;
    }

    /* â”€â”€ Game list â”€â”€ */
    .gameCard {
      display: flex;
      gap: 10px;
      align-items: flex-start;
      padding: 9px 12px;
      border: 1px solid var(--line);
      border-radius: 10px;
      background: rgba(15, 23, 42, .35);
      font-weight: 500;
      transition: background .15s;
    }

    .gameCard:hover {
      background: rgba(15, 23, 42, .55);
    }

    .gameCard input[type="checkbox"] {
      width: auto;
      margin-top: 2px;
    }

    .small {
      font-size: 12px;
      color: var(--muted)
    }

    .divider {
      height: 1px;
      background: var(--line);
      margin: 12px 0;
    }

    .row {
      margin: 0 0 12px;
    }

    .row:last-child {
      margin-bottom: 0;
    }

    .grid2 {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }

    @media (min-width:700px) {
      .grid2 {
        grid-template-columns: 1fr 1fr;
      }
    }
  </style>

  <script>
    /* â”€â”€ Inline Error â”€â”€ */
    function showInlineError(msg) {
      const el = document.getElementById('inlineErr');
      if (!el) return;
      el.textContent = msg;
      el.style.display = msg ? 'block' : 'none';
    }

    /* â”€â”€ Tabs â”€â”€ */
    function switchTab(tabId) {
      document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tabId));
      document.querySelectorAll('.tabPanel').forEach(p => p.classList.toggle('active', p.id === tabId));
    }

    /* â”€â”€ Settings toggle â”€â”€ */
    function toggleSettings() {
      const body = document.getElementById('settingsBody');
      const arrow = document.getElementById('settingsArrow');
      const isOpen = body.classList.toggle('open');
      arrow.classList.toggle('open', isOpen);
    }

    /* â”€â”€ Game selection helpers â”€â”€ */
    function updateSelectedCount() {
      const out = document.getElementById('selCount');
      const bar = document.getElementById('barSelCount');
      const n = document.querySelectorAll('input[name="game_idx"]:checked').length;
      const txt = n > 0 ? `${n} ç›¤å·²å‹¾é¸` : '';
      if (out) out.textContent = txt;
      if (bar) bar.textContent = txt;
    }
    function selectAllGames() {
      document.querySelectorAll('input[name="game_idx"]').forEach(cb => cb.checked = true);
      updateSelectedCount();
    }
    function selectNoGames() {
      document.querySelectorAll('input[name="game_idx"]').forEach(cb => cb.checked = false);
      updateSelectedCount();
    }

    /* â”€â”€ Platform fields â”€â”€ */
    function updatePlatformFields() {
      const sel = document.getElementById('platformSel');
      const pf = sel ? (sel.value || 'auto') : 'auto';
      const lichWrap = document.getElementById('lichessUserWrap');
      const ccomWrap = document.getElementById('chesscomUserWrap');
      const lich = document.getElementById('lichessUser');
      const ccom = document.getElementById('chesscomUser');
      const showLich = (pf === 'auto' || pf === 'lichess');
      const showCcom = (pf === 'auto' || pf === 'chesscom');
      if (lichWrap) lichWrap.style.display = showLich ? 'block' : 'none';
      if (ccomWrap) ccomWrap.style.display = showCcom ? 'block' : 'none';
      if (lich) lich.disabled = !showLich;
      if (ccom) ccom.disabled = !showCcom;
    }

    /* â”€â”€ On Load â”€â”€ */
    window.addEventListener('load', () => {
      const sel = document.getElementById('platformSel');
      if (sel) sel.addEventListener('change', updatePlatformFields);
      document.querySelectorAll('input[name="game_idx"]').forEach(cb => {
        cb.addEventListener('change', updateSelectedCount);
      });
      updatePlatformFields();
      updateSelectedCount();

      // Auto-switch to online tab if preview games are showing
      {% if games and preview_token %}
      switchTab('tabOnline');
      {% endif %}
    });

    /* â”€â”€ Form submit validation â”€â”€ */
    function onSubmit(ev) {
      const file = document.querySelector('input[name="pgn"]');
      const text = document.querySelector('textarea[name="pgn_text"]');
      const lich = document.querySelector('input[name="lichess_user"]');
      const ccom = document.querySelector('input[name="chesscom_user"]');

      const hasFile = file && file.files && file.files.length > 0;
      const hasText = text && text.value && text.value.trim().length > 0;
      const hasOnline = (lich && lich.value.trim().length > 0) || (ccom && ccom.value.trim().length > 0);
      const pt = document.querySelector('input[name="preview_token"]');
      const hasPreview = pt && pt.value && pt.value.trim().length > 0;
      const hasSelection = document.querySelectorAll('input[name="game_idx"]:checked').length > 0;

      const submitterId = ev && ev.submitter ? ev.submitter.id : '';
      const isPreview = submitterId === 'previewBtn';

      if (isPreview) {
        const sel = document.getElementById('platformSel');
        const pf = sel ? (sel.value || 'auto') : 'auto';
        const hasLich = lich && lich.value && lich.value.trim().length > 0;
        const hasCcom = ccom && ccom.value && ccom.value.trim().length > 0;
        if (pf === 'lichess' && !hasLich) { showInlineError('è«‹è¼¸å…¥ Lichess usernameã€‚'); return false; }
        if (pf === 'chesscom' && !hasCcom) { showInlineError('è«‹è¼¸å…¥ Chess.com usernameã€‚'); return false; }
        if (pf === 'auto' && !hasLich && !hasCcom) { showInlineError('è«‹è‡³å°‘è¼¸å…¥ä¸€å€‹ usernameã€‚'); return false; }
        showInlineError('');
        return true;
      }

      if (!hasFile && !hasText && !hasOnline && !(hasPreview && hasSelection)) {
        showInlineError('è«‹é¸æ“‡è‡³å°‘ä¸€ç¨®è¼¸å…¥æ–¹å¼ï¼šç·šä¸ŠæŠ“æ£‹è­œã€ä¸Šå‚³ PGN æˆ–è²¼ä¸Š PGNã€‚');
        return false;
      }
      if (hasPreview && !hasSelection && !hasFile && !hasText) {
        showInlineError('è«‹è‡³å°‘å‹¾é¸ 1 ç›¤å°å±€ã€‚');
        return false;
      }

      showInlineError('');
      const btn = document.getElementById('submitBtn');
      const barBtn = document.getElementById('barSubmitBtn');
      if (btn) { btn.disabled = true; btn.textContent = 'åˆ†æä¸­â€¦'; }
      if (barBtn) { barBtn.disabled = true; barBtn.textContent = 'åˆ†æä¸­â€¦è«‹ç¨ç­‰'; }
      return true;
    }
  </script>
</head>

<body>
  <div class="wrap">
    <div class="header">
      <div class="brand">
        <h1>ChessDNA</h1>
        <p>Stockfish å¼•æ“åˆ†æ Â· CPL / Accuracy / Turning Points</p>
      </div>
      <div class="pill">MVP v0.1</div>
    </div>

    <form class="card" action="/analyze" method="post" enctype="multipart/form-data" onsubmit="return onSubmit(event);">

      <div class="cardHead"><strong>Analyze PGN</strong></div>
      <div class="cardBody">

        <div id="inlineWarn"
          style="{% if inline_warn %}display:block{% else %}display:none{% endif %};margin:0 0 10px;padding:9px 12px;border:1px solid rgba(245,158,11,.35);background:rgba(245,158,11,.10);border-radius:10px;color:#fde68a;font-size:13px;">
          {{ inline_warn or '' }}</div>
        <div id="inlineErr"
          style="{% if inline_err %}display:block{% else %}display:none{% endif %};margin:0 0 10px;padding:9px 12px;border:1px solid rgba(239,68,68,.35);background:rgba(239,68,68,.10);border-radius:10px;color:#fecaca;font-size:13px;">
          {{ inline_err or '' }}</div>

        {# â”€â”€ Player Name (always visible) â”€â”€ #}
        <div class="row">
          <label>ç©å®¶åç¨± <span style="font-weight:400;color:var(--muted)">â€” æ¯”å° PGN çš„ White/Blackï¼Œç•™ç©ºé¡¯ç¤ºå…¨éƒ¨</span></label>
          <input type="text" name="player_name" placeholder="ä¾‹ï¼šorange0730"
            value="{{ (prefill.player_name if prefill is defined else '') }}" />
        </div>

        <div class="divider"></div>

        {# â”€â”€ Tabs â”€â”€ #}
        <div class="tabs">
          <button type="button" class="tab active" data-tab="tabOnline" onclick="switchTab('tabOnline')">ğŸŒ
            ç·šä¸ŠæŠ“æ£‹è­œ</button>
          <button type="button" class="tab" data-tab="tabUpload" onclick="switchTab('tabUpload')">ğŸ“ ä¸Šå‚³æª”æ¡ˆ</button>
          <button type="button" class="tab" data-tab="tabPaste" onclick="switchTab('tabPaste')">ğŸ“‹ è²¼ä¸Š PGN</button>
        </div>

        {# â”€â”€ Tab: Online â”€â”€ #}
        <div id="tabOnline" class="tabPanel active">
          <div class="row">
            <div class="grid2">
              <div>
                <select id="platformSel" name="platform" title="é¸æ“‡å¹³å°">
                  {% set pf = (prefill.platform if prefill is defined and prefill.platform is defined else 'auto') %}
                  <option value="auto" {% if pf=='auto' %}selected{% endif %}>å¹³å°ï¼šè‡ªå‹•</option>
                  <option value="lichess" {% if pf=='lichess' %}selected{% endif %}>Lichess</option>
                  <option value="chesscom" {% if pf=='chesscom' %}selected{% endif %}>Chess.com</option>
                </select>
              </div>
              <div>
                <input type="number" name="fetch_max" step="1" min="1" max="50"
                  value="{{ (prefill.fetch_max if prefill is defined else 10) }}" placeholder="æœ€å¤šå¹¾ç›¤ (1~50)"
                  title="æœ€å¤šæŠ“å¹¾ç›¤" aria-label="fetch_max" />
              </div>
            </div>
          </div>
          <div class="row">
            <div class="grid2">
              <div id="lichessUserWrap">
                <input id="lichessUser" type="text" name="lichess_user" placeholder="Lichess username"
                  value="{{ (prefill.lichess_user if prefill is defined else '') }}" />
              </div>
              <div id="chesscomUserWrap">
                <input id="chesscomUser" type="text" name="chesscom_user" placeholder="Chess.com username"
                  value="{{ (prefill.chesscom_user if prefill is defined else '') }}" />
              </div>
            </div>
          </div>
          <div class="btnRow">
            <button id="previewBtn" class="btn btnOutline" type="submit" formaction="/preview" formmethod="post">æŠ“å‡ºå°å±€
              â†’</button>
            <span class="small">ä¹Ÿå¯è·³é previewï¼Œç›´æ¥ã€Œé–‹å§‹åˆ†æã€ã€‚</span>
          </div>

          {% if games and preview_token %}
          <div class="divider"></div>
          <div class="row">
            <input type="hidden" name="preview_token" value="{{ preview_token }}" />
            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
              <label style="margin:0;">å·²æŠ“åˆ° {{ games|length }} ç›¤</label>
              {% if preview_platform %}<span class="small">ï¼ˆä¾†æºå¹³å°ï¼š{{ preview_platform }}ï¼‰</span>{% endif %}
              <span id="selCount" class="small" style="margin-left:auto;"></span>
            </div>
            <div class="btnRow" style="margin-top:0;margin-bottom:10px;">
              <button class="btn" type="button" onclick="selectAllGames();"
                style="padding:6px 12px;font-size:12px;">å…¨é¸</button>
              <button class="btn" type="button" onclick="selectNoGames();"
                style="padding:6px 12px;font-size:12px;">å…¨ä¸é¸</button>
            </div>
            <div
              style="display:grid;grid-template-columns:1fr;gap:6px;max-height:320px;overflow-y:auto;padding-right:4px;">
              {% for g in games %}
              <label class="gameCard">
                <input type="checkbox" name="game_idx" value="{{ g.idx }}" checked />
                <div>
                  <div style="font-size:13px;">{{ g.white }} vs {{ g.black }} <span class="small">({{ g.result
                      }})</span></div>
                  <div class="small">{{ g.date }} Â· {{ g.event }}</div>
                </div>
              </label>
              {% endfor %}
            </div>
          </div>
          {% endif %}
        </div>

        {# â”€â”€ Tab: Upload â”€â”€ #}
        <div id="tabUpload" class="tabPanel">
          <div class="row">
            <label>é¸æ“‡ PGN æª”æ¡ˆ</label>
            <input type="file" name="pgn" accept=".pgn,.txt" />
            <div class="hint">æ”¯æ´ .pgn å’Œ .txt æ ¼å¼ã€‚</div>
          </div>
        </div>

        {# â”€â”€ Tab: Paste â”€â”€ #}
        <div id="tabPaste" class="tabPanel">
          <div class="row">
            <label>PGN æ–‡å­—</label>
            <textarea name="pgn_text" rows="10" placeholder="è²¼ä¸Š PGN å…§å®¹â€¦"></textarea>
          </div>
        </div>

        <div class="divider"></div>

        {# â”€â”€ Collapsible Settings â”€â”€ #}
        <div class="settingsToggle" onclick="toggleSettings()">
          <span id="settingsArrow" class="arrow">â–¶</span>
          <strong style="font-size:13px;">Settings</strong>
          <span class="settingsSummary" id="settingsSummary">
            {{ (prefill.time_per_move if prefill is defined and prefill.time_per_move is defined else 0.05) }}s / {{
            (prefill.max_plies if prefill is defined and prefill.max_plies is defined else 200) }} plies
          </span>
        </div>
        <div id="settingsBody" class="settingsBody">
          <div class="row">
            <label>Stockfish è·¯å¾‘</label>
            <input type="text" name="engine_path"
              value="{{ (prefill.engine_path if prefill is defined and prefill.engine_path is defined and prefill.engine_path else default_engine) }}"
              title="å¯ç”¨ç’°å¢ƒè®Šæ•¸ STOCKFISH_PATH è¦†è“‹" />
          </div>
          <div class="grid2">
            <div class="row">
              <label>æ¯æ­¥æ€è€ƒæ™‚é–“ï¼ˆç§’ï¼‰</label>
              <input type="number" name="time_per_move" step="0.01" min="0.01"
                value="{{ (prefill.time_per_move if prefill is defined and prefill.time_per_move is defined else default_time) }}"
                title="å»ºè­° 0.05~0.10s" />
            </div>
            <div class="row">
              <label>æœ€å¤šåˆ†æ plies</label>
              <input type="number" name="max_plies" step="1" min="10"
                value="{{ (prefill.max_plies if prefill is defined and prefill.max_plies is defined else 200) }}"
                title="å¤ªå¤§æœƒå¾ˆæ…¢ï¼Œé è¨­ 200" />
            </div>
          </div>
        </div>

        {# â”€â”€ Inline submit (fallback for no-JS) â”€â”€ #}
        <div class="btnRow" style="margin-top:4px;">
          <button id="submitBtn" class="btn" type="submit" style="display:none;">é–‹å§‹åˆ†æ</button>
        </div>

      </div>
    </form>
  </div>

  {# â”€â”€ Sticky Action Bar â”€â”€ #}
  <div class="actionBar">
    <span id="barSelCount" class="actionInfo"></span>
    <button id="barSubmitBtn" class="btnAnalyze" type="submit" form="" onclick="
      const f=document.querySelector('form');
      if(f){
        const e=new Event('submit',{bubbles:true,cancelable:true});
        e.submitter=this;
        if(f.dispatchEvent(e)){f.submit();}
      }
    ">ğŸ” é–‹å§‹åˆ†æ</button>
    <span class="actionInfo" style="max-width:180px;">è€—æ™‚å–æ±ºæ–¼ plies èˆ‡æ¯æ­¥ç§’æ•¸</span>
  </div>

  <!-- PWA: Install Banner -->
  <div id="installBanner"
    style="display:none;position:fixed;bottom:90px;left:50%;transform:translateX(-50%);
    z-index:200;background:rgba(17,24,39,.95);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);
    border:1px solid rgba(96,165,250,.3);border-radius:14px;padding:12px 18px;
    display:none;align-items:center;gap:12px;box-shadow:0 8px 32px rgba(0,0,0,.4);max-width:420px;width:calc(100% - 32px);">
    <img src="/static/icons/icon-192.png" alt="" style="width:40px;height:40px;border-radius:10px;" />
    <div style="flex:1;min-width:0;">
      <div style="font-size:14px;font-weight:700;">å®‰è£ ChessDNA App</div>
      <div style="font-size:12px;color:#9ca3af;" id="installHint">åŠ åˆ°ä¸»ç•«é¢ï¼ŒåƒåŸç”Ÿ App ä¸€æ¨£ä½¿ç”¨</div>
    </div>
    <button id="installBtn" onclick="installPWA()" style="padding:8px 16px;border:none;border-radius:10px;
      background:linear-gradient(135deg,#3b82f6,#2563eb);color:#fff;font-size:13px;font-weight:700;
      cursor:pointer;white-space:nowrap;">å®‰è£</button>
    <button onclick="dismissInstall()" style="background:none;border:none;color:#9ca3af;
      font-size:18px;cursor:pointer;padding:4px;line-height:1;">âœ•</button>
  </div>

  <!-- PWA: Service Worker + Install Logic -->
  <script>
    // Register service worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js', { scope: '/' })
        .catch(() => { });
    }

    // Android / Chrome install prompt
    let deferredPrompt = null;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      if (!localStorage.getItem('chessdna_install_dismissed')) {
        showInstallBanner();
      }
    });

    function showInstallBanner() {
      const b = document.getElementById('installBanner');
      if (b) b.style.display = 'flex';
    }

    function installPWA() {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then(() => { deferredPrompt = null; });
      }
      dismissInstall();
    }

    function dismissInstall() {
      const b = document.getElementById('installBanner');
      if (b) b.style.display = 'none';
      localStorage.setItem('chessdna_install_dismissed', '1');
    }

    // iOS: detect Safari and show manual instruction
    window.addEventListener('load', () => {
      const isIos = /iphone|ipad|ipod/i.test(navigator.userAgent);
      const isStandalone = window.navigator.standalone === true;
      if (isIos && !isStandalone && !localStorage.getItem('chessdna_install_dismissed')) {
        const hint = document.getElementById('installHint');
        const btn = document.getElementById('installBtn');
        if (hint) hint.textContent = 'é» Safari åˆ†äº«æŒ‰éˆ• â†’ åŠ åˆ°ä¸»ç•«é¢';
        if (btn) btn.textContent = 'çŸ¥é“äº†';
        showInstallBanner();
      }
    });
  </script>
</body>

</html>