<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ChessDNA Report</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial;max-width:1100px;margin:24px auto;padding:0 16px;}
    table{border-collapse:collapse;width:100%;}
    th,td{border-bottom:1px solid #eee;padding:6px 8px;font-size:13px;}
    th{text-align:left;position:sticky;top:0;background:#fff;}
    .tag{padding:2px 6px;border-radius:10px;font-size:12px;display:inline-block;}
    .ok{background:#e8f5e9;}
    .inaccuracy{background:#fff8e1;}
    .mistake{background:#ffe0b2;}
    .blunder{background:#ffccbc;}
    code{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;}

    .filters{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:10px 0 14px;}
    .chip{border:1px solid #ddd;border-radius:999px;padding:6px 10px;background:#fff;cursor:pointer;font-size:13px;}
    .chip input{margin-right:6px;}

    tr.tp{background:#fff3e0;}
    tr.worst{background:#ffebee;}
    tr.playerRow td:first-child{font-weight:700;}

    .muted{color:#666;}
  </style>

  <script>
    function applyFilters(gameIndex){
      const root=document.getElementById('game-'+gameIndex);
      if(!root) return;

      const onlyPlayer = root.querySelector('input[data-filter="onlyPlayer"]').checked;
      const onlyBad    = root.querySelector('input[data-filter="onlyBad"]').checked;
      const onlyTP     = root.querySelector('input[data-filter="onlyTP"]').checked;
      const onlyWorst  = root.querySelector('input[data-filter="onlyWorst"]').checked;

      const rows = root.querySelectorAll('tbody tr[data-ply]');
      rows.forEach(r=>{
        let show=true;
        if(onlyPlayer && r.dataset.isPlayer !== '1') show=false;
        if(onlyBad && !(r.dataset.label==='inaccuracy' || r.dataset.label==='mistake' || r.dataset.label==='blunder')) show=false;
        if(onlyTP && r.dataset.isTurning !== '1') show=false;
        if(onlyWorst && r.dataset.isWorst !== '1') show=false;
        r.style.display = show ? '' : 'none';
      });
    }

    function jumpToPly(gameIndex, ply){
      const root=document.getElementById('game-'+gameIndex);
      if(!root) return;
      const row = root.querySelector('tr[data-ply="' + ply + '"]');
      if(!row) return;

      // make sure row isn't hidden by filters
      row.style.display = '';

      row.scrollIntoView({behavior:'smooth', block:'center'});
      row.style.transition = 'background-color 0.2s ease';
      const prev = row.style.backgroundColor;
      row.style.backgroundColor = 'rgba(96,165,250,.22)';
      setTimeout(()=>{ row.style.backgroundColor = prev; }, 900);
    }
  </script>
</head>
<body>
  <h1>ChessDNA Report</h1>
  <p>
    Engine: <code>{{ report.engine_path }}</code><br/>
    time_per_move: {{ report.time_per_move }}s, max_plies: {{ report.max_plies }}<br/>
    {% if report.player_name %}
      player: <code>{{ report.player_name }}</code><br/>
    {% endif %}
    debug json: <code>{{ debug_path }}</code>
  </p>

  {% if report.player_overview %}
    <div style="border:1px solid #eee;border-radius:14px;padding:12px;margin:10px 0 18px;">
      <div style="font-weight:800;">Player overview — {{ report.player_overview.player_name }}</div>
      <div class="muted">Games found: {{ report.player_overview.games_found }} / {{ report.player_overview.games_total }}</div>
      <div>
        Avg CPL: {{ '%.1f' % report.player_overview.avg_cpl if report.player_overview.avg_cpl is not none else 'n/a' }}
        | Accuracy: {{ '%.1f' % report.player_overview.accuracy if report.player_overview.accuracy is not none else 'n/a' }}
      </div>
      <div>
        Inaccuracy: {{ report.player_overview.inaccuracy }} | Mistake: {{ report.player_overview.mistake }} | Blunder: {{ report.player_overview.blunder }}
      </div>
    </div>
  {% endif %}

  {% for g in report.games %}
    <hr/>
    <h2>
      Game {{ loop.index }}
      {% if g.headers.get('White') and g.headers.get('Black') %}
        — {{ g.headers.get('White') }} vs {{ g.headers.get('Black') }}
      {% endif %}
    </h2>

    {% if g.turning_points and g.turning_points|length > 0 %}
      <p><strong>Turning points (top CPL plies)</strong>: {{ g.turning_points | join(', ') }}</p>
      <div class="muted" style="margin:6px 0 10px;">
        {% for ply in g.turning_points %}
          {% set p = g.plies[ply-1] %}
          <div style="margin:4px 0;">
            <a href="#" onclick="jumpToPly({{ loop.parent.index }}, {{ ply }}); return false;">#{{ ply }}</a>
            <code>{{ p.san }}</code>
            — CPL {{ p.cpl }}
            | best: <code>{{ p.bestmove_uci }}</code>
            {% if p.pv_uci and p.pv_uci|length>0 %}
              | pv: <code>{{ (p.pv_uci[:6]) | join(' ') }}</code>
            {% endif %}
          </div>
        {% endfor %}
      </div>
    {% endif %}

    <p>
      Avg CPL (W): {{ '%.1f' % g.avg_cpl_white if g.avg_cpl_white is not none else 'n/a' }}
      | Accuracy (W): {{ '%.1f' % g.accuracy_white if g.accuracy_white is not none else 'n/a' }}<br/>
      Avg CPL (B): {{ '%.1f' % g.avg_cpl_black if g.avg_cpl_black is not none else 'n/a' }}
      | Accuracy (B): {{ '%.1f' % g.accuracy_black if g.accuracy_black is not none else 'n/a' }}
    </p>

    {% if report.player_name %}
      <div style="border:1px solid #eee;border-radius:12px;padding:12px;margin:10px 0;">
        <div style="font-weight:700;">{{ report.player_name }}（{{ g.player_side if g.player_side else 'not found in headers' }}）</div>
        <div>
          Avg CPL: {{ '%.1f' % g.player_avg_cpl if g.player_avg_cpl is not none else 'n/a' }}
          | Accuracy: {{ '%.1f' % g.player_accuracy if g.player_accuracy is not none else 'n/a' }}
        </div>
        <div>
          Inaccuracy: {{ g.player_inaccuracy }} | Mistake: {{ g.player_mistake }} | Blunder: {{ g.player_blunder }}
        </div>
        {% if g.player_worst and g.player_worst|length > 0 %}
          <div>Worst plies: {{ g.player_worst | join(', ') }}</div>
        {% endif %}
      </div>
    {% endif %}

    <div id="game-{{ loop.index }}">
      <div class="filters">
        <label class="chip"><input type="checkbox" data-filter="onlyPlayer" onchange="applyFilters({{ loop.index }})" {% if report.player_name %}{% else %}disabled{% endif %}/>只看 player</label>
        <label class="chip"><input type="checkbox" data-filter="onlyBad" onchange="applyFilters({{ loop.index }})"/>只看失誤(>=inaccuracy)</label>
        <label class="chip"><input type="checkbox" data-filter="onlyTP" onchange="applyFilters({{ loop.index }})"/>只看 turning points</label>
        <label class="chip"><input type="checkbox" data-filter="onlyWorst" onchange="applyFilters({{ loop.index }})" {% if report.player_name %}{% else %}disabled{% endif %}/>只看 player worst</label>
        <span class="muted">提示：CPL 越大越傷。</span>
      </div>

      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Side</th>
            <th>Move</th>
            <th>Best (cp)</th>
            <th>Played (cp)</th>
            <th>CPL</th>
            <th>Acc</th>
            <th>Label</th>
          </tr>
        </thead>
        <tbody>
          {% for p in g.plies %}
            {% set is_turning = (p.ply in g.turning_points) %}
            {% set is_worst = (report.player_name and (p.ply in g.player_worst)) %}
            {% set is_player = (report.player_name and g.player_side and (p.side == g.player_side)) %}
            <tr
              data-ply="{{ p.ply }}"
              data-side="{{ p.side }}"
              data-label="{{ p.label }}"
              data-is-turning="{{ 1 if is_turning else 0 }}"
              data-is-worst="{{ 1 if is_worst else 0 }}"
              data-is-player="{{ 1 if is_player else 0 }}"
              class="{% if is_turning %}tp{% endif %} {% if is_worst %}worst{% endif %} {% if is_player %}playerRow{% endif %}"
            >
              <td>{{ p.ply }}</td>
              <td>{{ p.side }}</td>
              <td><code>{{ p.san }}</code></td>
              <td>{{ p.best_cp }}</td>
              <td>{{ p.played_cp }}</td>
              <td>{{ p.cpl }}</td>
              <td>{{ '%.1f' % p.accuracy if p.accuracy is not none else '' }}</td>
              <td><span class="tag {{ p.label }}">{{ p.label }}</span></td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% endfor %}

  <p><a href="/">回首頁</a></p>
</body>
</html>
