<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ChessDNA Report</title>
  <style>
    :root{
      --bg:#0b0f19;
      --card:#111827;
      --card2:#0f172a;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --line:rgba(255,255,255,.08);
      --accent:#60a5fa;
      --bad:#fb7185;
      --warn:#fbbf24;
      --ok:#34d399;
    }
    *{box-sizing:border-box;}
    body{
      font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial;
      margin:0;
      background: radial-gradient(1000px 600px at 20% 0%, rgba(96,165,250,.18), transparent 60%),
                  radial-gradient(800px 500px at 90% 10%, rgba(34,197,94,.12), transparent 60%),
                  var(--bg);
      color:var(--text);
    }
    a{color:rgba(96,165,250,.95);text-decoration:none;}
    a:hover{text-decoration:underline;}

    .wrap{max-width:1200px;margin:28px auto;padding:0 16px;}
    .topbar{display:flex;align-items:flex-end;justify-content:space-between;gap:12px;margin-bottom:14px;}
    .topbar h1{margin:0;font-size:26px;}
    .muted{color:var(--muted);}
    code{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;}

    .card{background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));border:1px solid var(--line);border-radius:16px;overflow:hidden;}
    .cardHead{padding:12px 14px;border-bottom:1px solid var(--line);background:rgba(17,24,39,.55);font-weight:800;}
    .cardBody{padding:14px;}

    table{border-collapse:collapse;width:100%;}
    th,td{border-bottom:1px solid var(--line);padding:7px 8px;font-size:13px;vertical-align:top;}
    th{text-align:left;position:sticky;top:0;background:rgba(17,24,39,.92);backdrop-filter: blur(6px);}

    .tag{padding:2px 8px;border-radius:999px;font-size:12px;display:inline-block;border:1px solid var(--line);}
    .tag.ok{background:rgba(52,211,153,.12);}
    .tag.inaccuracy{background:rgba(251,191,36,.12);}
    .tag.mistake{background:rgba(251,146,60,.12);}
    .tag.blunder{background:rgba(251,113,133,.14);}

    .filters{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:10px 0 14px;}
    .chip{border:1px solid var(--line);border-radius:999px;padding:6px 10px;background:rgba(255,255,255,.03);cursor:pointer;font-size:13px;color:var(--text);}
    .chip input{margin-right:6px;}

    tr.tp{background:rgba(251,191,36,.08);}
    tr.worst{background:rgba(251,113,133,.08);}
    tr.playerRow td:first-child{font-weight:800;}

    .kv{display:grid;grid-template-columns: 160px 1fr;gap:6px 10px;font-size:13px;}
    .kv div{padding:2px 0;}

    .small{font-size:12px;color:var(--muted);}
  </style>

  <script>
    function applyFilters(gameIndex){
      const root=document.getElementById('game-'+gameIndex);
      if(!root) return;

      const onlyPlayer = root.querySelector('input[data-filter="onlyPlayer"]').checked;
      const onlyBad    = root.querySelector('input[data-filter="onlyBad"]').checked;
      const onlyTP     = root.querySelector('input[data-filter="onlyTP"]').checked;
      const onlyWorst  = root.querySelector('input[data-filter="onlyWorst"]').checked;

      const rows = root.querySelectorAll('tbody tr[data-ply]');
      rows.forEach(r=>{
        let show=true;
        if(onlyPlayer && r.dataset.isPlayer !== '1') show=false;
        if(onlyBad && !(r.dataset.label==='inaccuracy' || r.dataset.label==='mistake' || r.dataset.label==='blunder')) show=false;
        if(onlyTP && r.dataset.isTurning !== '1') show=false;
        if(onlyWorst && r.dataset.isWorst !== '1') show=false;
        r.style.display = show ? '' : 'none';
      });
    }

    function jumpToPly(gameIndex, ply){
      const root=document.getElementById('game-'+gameIndex);
      if(!root) return;
      const row = root.querySelector('tr[data-ply="' + ply + '"]');
      if(!row) return;

      // make sure row isn't hidden by filters
      row.style.display = '';

      row.scrollIntoView({behavior:'smooth', block:'center'});
      row.style.transition = 'background-color 0.2s ease';
      const prev = row.style.backgroundColor;
      row.style.backgroundColor = 'rgba(96,165,250,.22)';
      setTimeout(()=>{ row.style.backgroundColor = prev; }, 900);
    }
  </script>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <h1>ChessDNA Report</h1>
        <div class="small">回到 <a href="/">首頁</a></div>
      </div>
      <div class="small muted">debug json: <code>{{ debug_path }}</code></div>
    </div>

    <div class="card" style="margin-bottom:14px;">
      <div class="cardHead">Run info</div>
      <div class="cardBody">
        <div class="kv">
          <div class="muted">Engine</div><div><code>{{ report.engine_path }}</code></div>
          <div class="muted">time_per_move</div><div>{{ report.time_per_move }}s</div>
          <div class="muted">max_plies</div><div>{{ report.max_plies }}</div>
          {% if report.player_name %}
            <div class="muted">player</div><div><code>{{ report.player_name }}</code></div>
          {% endif %}
        </div>
      </div>
    </div>

    {% if report.player_overview %}
      <div class="card" style="margin-bottom:14px;">
        <div class="cardHead">Player overview — {{ report.player_overview.player_name }}</div>
        <div class="cardBody">
          <div class="small muted">Games found: {{ report.player_overview.games_found }} / {{ report.player_overview.games_total }}</div>
          <div style="margin-top:8px;">
            Avg CPL: {{ '%.1f' % report.player_overview.avg_cpl if report.player_overview.avg_cpl is not none else 'n/a' }}
            | Accuracy: {{ '%.1f' % report.player_overview.accuracy if report.player_overview.accuracy is not none else 'n/a' }}
          </div>
          <div style="margin-top:6px;">
            Inaccuracy: {{ report.player_overview.inaccuracy }} | Mistake: {{ report.player_overview.mistake }} | Blunder: {{ report.player_overview.blunder }}
          </div>
        </div>
      </div>
    {% endif %}

  {% for g in report.games %}
    {% set game_index = loop.index %}
    <hr/>
    <h2>
      Game {{ loop.index }}
      {% if g.headers.get('White') and g.headers.get('Black') %}
        — {{ g.headers.get('White') }} vs {{ g.headers.get('Black') }}
      {% endif %}
    </h2>

    {% if g.turning_points and g.turning_points|length > 0 %}
      <p><strong>Turning points (top CPL plies)</strong>: {{ g.turning_points | join(', ') }}</p>
      <div class="muted" style="margin:6px 0 10px;">
        {% for ply in g.turning_points %}
          {% set p = g.plies[ply-1] %}
          <div style="margin:4px 0;">
            <a href="#" onclick="jumpToPly({{ game_index }}, {{ ply }}); return false;">#{{ ply }}</a>
            <code>{{ p.san }}</code>
            — CPL {{ p.cpl }}
            | best: <code>{{ p.bestmove_uci }}</code>
            {% if p.pv_uci and p.pv_uci|length>0 %}
              | pv: <code>{{ (p.pv_uci[:6]) | join(' ') }}</code>
            {% endif %}
          </div>
        {% endfor %}
      </div>
    {% endif %}

    <p>
      Avg CPL (W): {{ '%.1f' % g.avg_cpl_white if g.avg_cpl_white is not none else 'n/a' }}
      | Accuracy (W): {{ '%.1f' % g.accuracy_white if g.accuracy_white is not none else 'n/a' }}<br/>
      Avg CPL (B): {{ '%.1f' % g.avg_cpl_black if g.avg_cpl_black is not none else 'n/a' }}
      | Accuracy (B): {{ '%.1f' % g.accuracy_black if g.accuracy_black is not none else 'n/a' }}
    </p>

    {% if report.player_name %}
      <div class="card" style="margin:10px 0;">
        <div class="cardHead">{{ report.player_name }}（{{ g.player_side if g.player_side else 'not found in headers' }}）</div>
        <div class="cardBody">
          <div>
            Avg CPL: {{ '%.1f' % g.player_avg_cpl if g.player_avg_cpl is not none else 'n/a' }}
            | Accuracy: {{ '%.1f' % g.player_accuracy if g.player_accuracy is not none else 'n/a' }}
          </div>
          <div style="margin-top:6px;">
            Inaccuracy: {{ g.player_inaccuracy }} | Mistake: {{ g.player_mistake }} | Blunder: {{ g.player_blunder }}
          </div>
          {% if g.player_worst and g.player_worst|length > 0 %}
            <div style="margin-top:6px;">Worst plies: {{ g.player_worst | join(', ') }}</div>
          {% endif %}
        </div>
      </div>
    {% endif %}

    <div id="game-{{ loop.index }}">
      <div class="filters">
        <label class="chip"><input type="checkbox" data-filter="onlyPlayer" onchange="applyFilters({{ loop.index }})" {% if report.player_name %}{% else %}disabled{% endif %}/>只看 player</label>
        <label class="chip"><input type="checkbox" data-filter="onlyBad" onchange="applyFilters({{ loop.index }})"/>只看失誤(>=inaccuracy)</label>
        <label class="chip"><input type="checkbox" data-filter="onlyTP" onchange="applyFilters({{ loop.index }})"/>只看 turning points</label>
        <label class="chip"><input type="checkbox" data-filter="onlyWorst" onchange="applyFilters({{ loop.index }})" {% if report.player_name %}{% else %}disabled{% endif %}/>只看 player worst</label>
        <span class="muted">提示：CPL 越大越傷。</span>
      </div>

      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Side</th>
            <th>Move</th>
            <th>Best (cp)</th>
            <th>Played (cp)</th>
            <th>CPL</th>
            <th>Acc</th>
            <th>Label</th>
          </tr>
        </thead>
        <tbody>
          {% for p in g.plies %}
            {% set is_turning = (p.ply in g.turning_points) %}
            {% set is_worst = (report.player_name and (p.ply in g.player_worst)) %}
            {% set is_player = (report.player_name and g.player_side and (p.side == g.player_side)) %}
            <tr
              data-ply="{{ p.ply }}"
              data-side="{{ p.side }}"
              data-label="{{ p.label }}"
              data-is-turning="{{ 1 if is_turning else 0 }}"
              data-is-worst="{{ 1 if is_worst else 0 }}"
              data-is-player="{{ 1 if is_player else 0 }}"
              class="{% if is_turning %}tp{% endif %} {% if is_worst %}worst{% endif %} {% if is_player %}playerRow{% endif %}"
            >
              <td>{{ p.ply }}</td>
              <td>{{ p.side }}</td>
              <td><code>{{ p.san }}</code></td>
              <td>{{ p.best_cp }}</td>
              <td>{{ p.played_cp }}</td>
              <td>{{ p.cpl }}</td>
              <td>{{ '%.1f' % p.accuracy if p.accuracy is not none else '' }}</td>
              <td><span class="tag {{ p.label }} {{ p.label }}">{{ p.label }}</span></td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% endfor %}

  <p><a href="/">回首頁</a></p>
</body>
</html>
